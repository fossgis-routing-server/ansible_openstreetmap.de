- name: Create umap system account
  system_account:
    name: "{{ umap__user }}"
    home: "{{ umap__basedir }}"

- name: Populate base directories
  file:
    dest: "{{ umap__basedir }}/{{ item }}"
    owner: "{{ umap__user }}"
    group: "{{ umap__user }}"
    state: directory
  loop:
    - umap
    - umap/iconpacks
    - userdata

- name: Install prerequisites
  apt:
    name:
      - ca-certificates
      - curl
      - wget
      - git

- name: Setup config file
  template:
    src: umap.conf.jinja
    dest: "{{ umap__basedir }}/umap.conf"
    owner: "{{ umap__user }}"
    group: "{{ umap__user }}"
    mode: "0644"

- name: Copy scripts
  copy:
    src: "umap_{{ item }}"
    dest: "{{ umap__basedir }}/{{ item }}"
    owner: "{{ umap__user }}"
    group: "{{ umap__user }}"
  loop:
    - init_db.sh
    - docker-compose.yml

- name: Setup umap db env file
  template:
    src: "{{ item }}.jinja"
    dest: "{{ umap__basedir }}/{{ item }}"
    owner: "{{ umap__user }}"
    group: "{{ umap__user }}"
    mode: "0644"
  loop:
    - database.env

- name: Setup umap docker env file
  template:
    src: "{{ item }}.jinja"
    dest: "{{ umap__basedir }}/.env"
    owner: "{{ umap__user }}"
    group: "{{ umap__user }}"
    mode: "0644"
  loop:
    - umap.env

- name: Setup db-helper script
  template:
    src: "{{ item }}.jinja"
    dest: "/usr/local/bin/{{ item }}"
    owner: "{{ umap__user }}"
    group: "{{ umap__user }}"
    mode: "0755"
  loop:
    - import_umapdb.sh
    - backup_umapdb.sh

- name: Add Docker GPG apt Key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker Repository
  apt_repository:
    repo: deb https://download.docker.com/linux/debian bookworm stable
    state: present

- name: Update apt and install docker-ce
  apt:
    name: docker-ce
    state: latest
    update_cache: true

- name: Install docker compose plugin
  apt:
    name: docker-compose-plugin
    state: latest
    update_cache: true

- name: Add "{{ umap__user }}" user to "docker" group
  user:
    name: "{{ umap__user }}"
    groups: docker
    append: yes

- name: Ensure Docker service is started
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Run Docker Compose up as user "{{ umap__user }}"
  become: true
  become_user: "{{ umap__user }}"
  command: docker compose -f "{{ umap__basedir }}"/docker-compose.yml up -d
  args:
    chdir: "{{ umap__basedir }}"
  environment:
    COMPOSE_HTTP_TIMEOUT: 200

- name: "umap nginx site and munin"
  nginx_site:
    site: 'umapde'
    src:  'nginx-umap.jinja'
