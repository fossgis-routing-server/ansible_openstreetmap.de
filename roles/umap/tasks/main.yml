- name: Create umap system account
  system_account:
    name: "{{ umap__user }}"
    home: "{{ umap__paths.host.basedir }}"
  register: umap_account

- name: Get umap UID
  command: id -u {{ umap__user }}
  register: umap_uid_result
  changed_when: false
  check_mode: false

- name: Set umap UID fact
  set_fact:
    umap_uid: "{{ umap_uid_result.stdout | int }}"

- name: Install prerequisites
  apt:
    name:
      - ca-certificates
      - curl
      - wget
      - git
      - logrotate

- name: Create apt keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Add Docker GPG apt Key
  get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'

- name: Add Docker Repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian trixie stable"
    state: present
  register: docker_repo_added

- name: Update apt cache
  apt:
    update_cache: yes
  when: docker_repo_added.changed

- name: Install Docker and Docker Compose
  apt:
    name:
      - docker-ce
      - docker-compose-plugin

- name: Get docker group GID
  command: getent group docker
  register: docker_gid_raw
  changed_when: false
  check_mode: false
  failed_when: false

- name: Set docker GID fact
  set_fact:
    umap_gid: "{{ docker_gid_raw.stdout.split(':')[2] | int }}"
  when: docker_gid_raw.rc == 0

- name: Set umap basedir permissions
  file:
    path: "{{ umap__paths.host.basedir }}"
    state: directory
    owner: "{{ umap__user }}"
    group: docker
    mode: "0775"

# Add login users to docker group
# We filter users based on their group membership (same logic as accounts.yml):
# - Users with group 'all' have access to all hosts
# - Users with groups matching the host's group_names have access
# Note: This filter determines which users SHOULD have access, but doesn't guarantee
# that the user accounts exist on the system.
- name: Gather active accounts for docker group
  set_fact:
    docker_users_active: "{{ docker_users_active | default([]) + [item.0.name] }}"
  when: "item.1 in group_names or item.1 == 'all'"
  loop: "{{ users | default([]) | subelements('groups', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.name | default('unknown') }}"
  no_log: true  # Suppress output of user data (SSH keys etc.)

- name: Add users to docker group
  user:
    name: "{{ item }}"
    groups: docker
    append: yes
  loop: "{{ [umap__user] + (docker_users_active | default([])) }}"
  register: docker_group_result
  ignore_errors: true   # User might not exist
  failed_when: false    # Don't fail playbook if user doesn't exist

- name: Setup umap db env file
  template:
    src: "{{ item }}.jinja"
    dest: "{{ umap__paths.host.basedir }}/{{ item }}"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0664"
  loop:
    - database.env

- name: Setup umap config file
  template:
    src: "umap.conf.jinja"
    dest: "{{ umap__paths.host.basedir }}/umap.conf"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0664"

- name: Create umap directory structure
  file:
    path: "{{ umap__paths.host.basedir }}/{{ item }}"
    state: directory
    owner: "{{ umap__user }}"
    group: docker
    mode: "0775"
  loop:
    - sockets
    - umapdata/static_root
    - umapdata/media_root
    - umapdata/symbols
    - umapdata/symbols/osmic
    - umapdata/symbols/osmic/pictograms
    - umapdata/symbols/brewery
    - umapdata/symbols/brewery/pictograms
    - nginx
    - nginx/cache
    - nginx/run

- name: Create and set setgid on nginx log directory
  file:
    path: "{{ umap__paths.host.basedir }}/nginx/logs"
    state: directory
    owner: "{{ umap__user }}"
    group: docker
    mode: "2775"

- name: Setup docker-compose file
  template:
    src: "umap_docker-compose.yml.jinja"
    dest: "{{ umap__paths.host.basedir }}/docker-compose.yml"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0664"

- name: Setup nginx-docker.conf for proxy
  template:
    src: "nginx-docker.conf.jinja"
    dest: "{{ umap__paths.host.basedir }}/nginx-docker.conf"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0664"

- name: Copy Docker build files and entrypoint
  copy:
    src: "{{ item.src }}"
    dest: "{{ umap__paths.host.basedir }}/{{ item.dest }}"
    owner: "{{ umap__user }}"
    group: docker
    mode: "{{ item.mode }}"
  loop:
    - { src: "Dockerfile", dest: "Dockerfile", mode: "0664" }
    - { src: ".dockerignore", dest: ".dockerignore", mode: "0664" }
    - { src: "entrypoint.sh", dest: "entrypoint.sh", mode: "0755" }

- name: Setup umap nginx site
  nginx_site:
    site: '000-umapde'
    src:  'nginx-host.conf.jinja'
  notify: reload nginx

- name: Configure uMap log format (extended anonymized)
  copy:
    src: 'umap_log_format.conf'
    dest: '/etc/nginx/conf.d/umap_log_format.conf'
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx

- name: Disable default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload nginx

- name: Ensure Docker service is started
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Copy favicon files
  copy:
    src: "favicon/{{ item.src }}"
    dest: "{{ umap__paths.host.basedir }}/umapdata/static_root/{{ item.dest }}"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0644"
  loop:
    - { src: favicon.ico, dest: favicon.ico }
    - { src: favicon.svg, dest: favicon.svg }
    - { src: favicon-96x96.png, dest: favicon-96x96.png }
    - { src: apple-touch-icon.png, dest: apple-touch-icon.png }
    - { src: apple-touch-icon.png, dest: apple-touch-icon-precomposed.png }
    - { src: site.webmanifest, dest: site.webmanifest }
    - { src: web-app-manifest-192x192.png, dest: web-app-manifest-192x192.png }
    - { src: web-app-manifest-512x512.png, dest: web-app-manifest-512x512.png }

- name: Create custom directories
  file:
    path: "{{ umap__paths.host.basedir }}/umapdata/custom/{{ item }}"
    state: directory
    owner: "{{ umap__user }}"
    group: docker
    mode: "0775"
  loop:
    - templates
    - templates/umap
    - static
    - static/umap

- name: Deploy custom website files
  copy:
    src: "custom_website/"
    dest: "{{ umap__paths.host.basedir }}/umapdata/custom/"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0644"
    directory_mode: "0775"

- name: Create scripts directory structure
  file:
    path: "{{ umap__paths.host.basedir }}/scripts/{{ item }}"
    state: directory
    owner: "{{ umap__user }}"
    group: docker
    mode: "0755"
  loop:
    - admin

- name: Deploy admin scripts
  copy:
    src: "admin_scripts/{{ item }}"
    dest: "{{ umap__paths.host.basedir }}/scripts/admin/{{ item }}"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0644"
  loop:
    - analyze_maps.py
    - analyze_users.py
    - get_map_details.py
    - get_user_details.py
    - umap_utils.py
  register: admin_scripts_deployed

- name: Deploy admin script wrapper with executable permissions
  copy:
    src: "admin_scripts/umap-admin"
    dest: "{{ umap__paths.host.basedir }}/scripts/admin/umap-admin"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0755"

- name: Create docs directory
  file:
    path: "{{ umap__paths.host.basedir }}/docs"
    state: directory
    owner: "{{ umap__user }}"
    group: docker
    mode: "0755"

- name: Deploy documentation files
  copy:
    src: "docs/{{ item }}"
    dest: "{{ umap__paths.host.basedir }}/docs/{{ item }}"
    owner: "{{ umap__user }}"
    group: docker
    mode: "0644"
  loop:
    - README_ADMINSCRIPTS.md
    - README_BACKUP.md
    - HOW_TO_SETUP_UMAP.md

- name: Run Docker Compose up
  command: docker compose -f "{{ umap__paths.host.basedir }}"/docker-compose.yml up -d
  args:
    chdir: "{{ umap__paths.host.basedir }}"
  environment:
    COMPOSE_HTTP_TIMEOUT: "200"
  become_user: "{{ umap__user }}"
  become: true
  register: docker_compose_up_result
  changed_when: "'Creating' in docker_compose_up_result.stdout or 'Starting' in docker_compose_up_result.stdout or 'Recreating' in docker_compose_up_result.stdout"
  failed_when: false

- name: Check if umap_app container is running
  command: docker inspect -f '{{ "{{" }}.State.Running{{ "}}" }}' umap_app
  register: container_running_check
  changed_when: false
  failed_when: false
  when: docker_compose_up_result is defined

- name: Fix cache directory permissions in Docker volume
  shell: |
    docker exec --user root umap_app chown -R {{ umap_uid }}:{{ umap_gid }} /srv/umap/cache 2>/dev/null || true
    docker exec --user root umap_app chmod 775 /srv/umap/cache 2>/dev/null || true
  when:
    - docker_compose_up_result is defined
    - container_running_check.stdout == "true"
  changed_when: false

- name: Setup logrotate configuration for uMap
  template:
    src: "logrotate-umap.conf.jinja"
    dest: "/etc/logrotate.d/umap"
    owner: root
    group: root
    mode: "0644"
  when: docker_compose_up_result.changed | default(false)
  notify: reload nginx

- name: Include backup tasks
  include_tasks: backup.yml
  when: umap__backup_enabled | default(false)
  tags:
    - umap
    - backup

- name: Include monitoring tasks
  include_tasks: monitoring.yml
  tags:
    - umap
    - monitoring
