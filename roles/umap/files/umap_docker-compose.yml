networks:
  reverseproxy_web:
    name: reverseproxy_web
#    external: true

services:

  db:
    healthcheck:
        test: ["CMD-SHELL", "pg_isready -d umapdb -U umapuser"]
        interval: 2s
    image: postgis/postgis:16-3.4-alpine
    container_name: umap_db
    env_file: ./database.env
    volumes:
      - umap_db:/var/lib/postgresql/data
      - ./init_db.sh:/docker-entrypoint-initdb.d/01-init_umap_db.sh
      - ./backupstorage:/tmp/backupstorage
      #- ./backup/umap_db.backup.sql:/tmp/umap_db.backup.sql:ro
    networks:
      - reverseproxy_web

  app:
    depends_on:
      db:
        condition: service_healthy
    image: umap/umap:2.6.3
    container_name: umap_app
    ports:
      - "127.0.0.1:8000:8000"
    volumes:
      - ./userdata/var/data:/srv/umap/data
      - ./userdata/custom:/srv/umap/custom
      - ./umap.conf:/etc/umap/umap.conf
      - ./iconpacks/osmic:/tmp/iconimport
    restart: always
    networks:
      - reverseproxy_web

volumes:
  umap_db:
