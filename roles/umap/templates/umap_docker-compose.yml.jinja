networks:
  reverseproxy_web:
    name: reverseproxy_web
#    external: true

services:
  redis:
    image: redis:latest
    container_name: umap_redis
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 1s
      timeout: 3s
      retries: 5
    command: ["redis-server"]
    restart: always
    logging:
      driver: journald
    networks:
      - reverseproxy_web

  db:
    image: postgis/postgis:17-3.5-alpine
    container_name: umap_db
    env_file: ./database.env
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d umapdb -U umapuser"]
      interval: 2s
      timeout: 5s
      retries: 5
    volumes:
      - umap_db:/var/lib/postgresql/data
      - ./init_db.sh:/docker-entrypoint-initdb.d/01-init_umap_db.sh
    environment:
      - POSTGRES_LOG_MIN_DURATION_STATEMENT=0
      - POSTGRES_LOG_STATEMENT=all
      - POSTGRES_LOG_DESTINATION=stderr
    restart: always
    logging:
      driver: journald
    networks:
      - reverseproxy_web

  app:
    # Custom WSGI Image mit WebSocket-Unterst√ºtzung
    build:
      context: .
      dockerfile: Dockerfile
      args:
        UMAP_VERSION: {{ umap_version | default('release') }}
    container_name: umap_app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - SOCKET_PATH=/srv/umap/sockets/umap.sock
    volumes:
      - ./umap.conf:/etc/umap/umap.conf
      - ./umapdata/symbols:/srv/umap/umapdata/symbols:ro
      - ./umapdata/media_root:/srv/umap/media_root
      - ./umapdata/static_root:/srv/umap/static_root
      - umap_cache:/srv/umap/cache
      - ./sockets:/srv/umap/sockets
    restart: always
    logging:
      driver: journald
    networks:
      - reverseproxy_web

  proxy:
    image: nginx:latest
    container_name: umap_proxy
    ports:
      - "127.0.0.1:{{ umap__proxy_port }}:80"
    volumes:
      - ./nginx-docker.conf:/etc/nginx/nginx.conf:ro
      - ./umapdata/static_root:/srv/umap/static_root:ro
      - ./umapdata/symbols:/symbols:ro
      - ./umapdata/media_root:/srv/umap/media_root:ro
      - ./sockets:/srv/umap/sockets:ro
    depends_on:
      - app
    restart: always
    logging:
      driver: journald
    networks:
      - reverseproxy_web

volumes:
  umap_db:
    name: umap_db_data
  umap_cache:
    name: umap_cache_data 