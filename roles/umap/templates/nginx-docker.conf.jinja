pid /var/run/nginx/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    # MIME types for JavaScript modules (.mjs)
    types {
        application/javascript mjs;
    }
    default_type  application/octet-stream;

    # Proxy cache for ajax proxy
    proxy_cache_path /var/cache/nginx/ajax_proxy_cache levels=1:2 keys_zone=ajax_proxy:10m inactive=60m;
    proxy_cache_key "$uri$is_args$args";

    sendfile        on;
    keepalive_timeout  65;

    # Error logging
    error_log /var/log/nginx/error.log warn;

    # Compression settings
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_min_length 1000;
    
    # Enhanced log format
    log_format detailed_ext '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            '"$http_referer" "$http_user_agent" '
                            'host=$host uri="$request_uri" '
                            'rt=$request_time';
    gzip_types
        application/atom+xml
        application/geo+json
        application/javascript
        application/x-javascript
        application/json
        application/ld+json
        application/manifest+json
        application/rdf+xml
        application/rss+xml
        application/xhtml+xml
        application/xml
        font/eot
        font/otf
        font/ttf
        image/svg+xml
        text/css
        text/javascript
        text/plain
        text/xml;

    # Markiere Upstream-HTML-Antworten 
    map $upstream_http_content_type $is_html {
        ~*text/html 1;
        default     0;
    }

    # Cache-Control für HTML-Antworten (no-store, must-revalidate)
    # Für alles andere: leer (wird ignoriert)
    map $is_html $html_cache_control {
        1 "no-store, must-revalidate";
        default "";
    }

    # Expires für HTML-Antworten (0 = sofort ablaufen)
    map $is_html $html_expires {
        1 "0";
        default "";
    }

    # Pragma für HTML-Antworten
    map $is_html $html_pragma {
        1 "no-cache";
        default "";
    }

    # Content-Type für .mjs Dateien
    map $uri $mjs_content_type {
        ~\.mjs$ "application/javascript";
        default "";
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream umap_app {
        server unix:{{ umap__paths.container.sockets }}/umap.sock;
    }

    server {
        listen 80;
        server_name localhost;
        
        # Allow larger request bodies for datalayer updates
        client_max_body_size 200M;
        client_body_buffer_size 4M;
        client_body_temp_path /var/cache/nginx/client_temp;
        
        # Proxy temp path for large responses (e.g., map downloads)
        proxy_temp_path /var/cache/nginx/proxy_temp;

        # Serve favicon files
        location /favicon.ico {
            alias {{ umap__paths.container.static_root }}/favicon.ico;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log /dev/null;
        }

        location /favicon.svg {
            alias {{ umap__paths.container.static_root }}/favicon.svg;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log /dev/null;
        }

        location ~ ^/apple-touch-icon(-precomposed)?\.png$ {
            alias {{ umap__paths.container.static_root }}/apple-touch-icon.png;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log /dev/null;
        }

        location /site.webmanifest {
            alias {{ umap__paths.container.static_root }}/site.webmanifest;
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Content-Type application/manifest+json;
            access_log /dev/null;
        }

        # Short cache for JS entry-points (umap.core.*.js, umap.controls.*.js, etc.)
        # Entry-points laden Chunk-Hashes und müssen nach Deploys schnell aktualisiert werden
        location ~ ^/static/umap/js/umap\.([\w]+)\.([a-zA-Z0-9]+)\.js$ {
            root {{ umap__paths.container.static_root }};
            rewrite ^/static/(.*)$ /$1 break;
            try_files $uri =404;
            add_header Cache-Control "public, max-age=600, must-revalidate, stale-while-revalidate=3600";
            access_log /dev/null;
            error_page 404 = @static_404;
        }

        # Serve static files directly
        location /static/ {
            root {{ umap__paths.container.static_root }};
            rewrite ^/static/(.*)$ /$1 break;
            try_files $uri =404;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log /dev/null;
            error_page 404 = @static_404;
        }
        
        # Fallback for missing static files - return 404 with no-cache headers
        # This prevents browsers from repeatedly requesting old files after container rebuilds
        # Note: nginx will send its default 404 page, but we prevent caching with headers
        location @static_404 {
            # Return 404 with no-cache headers to prevent browser from caching the 404
            # The default 404 page body is acceptable - browsers won't try to parse it as JS/CSS
            add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0" always;
            return 404;
        }

        # Serve old pictogram URLs (for existing maps)
        location /uploads/pictogram/ {
            alias {{ umap__paths.container.static_root }}/pictograms/;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # Serve uploads directly
        location /uploads/ {
            alias {{ umap__paths.container.media_root }}/;
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;  
            
            # Exclude direct access to geojson, as permissions must be checked by django
            location /uploads/datalayer/ { 
                return 404; 
            }
        }

        # X-Accel-Redirect for secure GeoJSON delivery
        location /internal/ {
            internal;
            gzip_vary on;
            gzip_static on;
            add_header X-DataLayer-Version $upstream_http_x_datalayer_version;
            alias {{ umap__paths.container.media_root }}/;
            access_log off;  
        }

        # Ajax proxy for CORS-protected data (internal only)
        # uMap uses this to load external data sources (e.g., Google Drive files)
        location ~ ^/proxy/(.*) {
            internal;
            add_header X-Proxy-Cache $upstream_cache_status always;
            proxy_cache_background_update on;
            proxy_cache_use_stale updating;
            proxy_cache ajax_proxy;
            proxy_cache_valid 1m;  # Default. uMap will override using X-Accel-Expires
            set $target_url $1;
            # URL is encoded, so we need a few hacks to clean it back.
            if ( $target_url ~ (.+)%3A%2F%2F(.+) ){ # fix :// between scheme and destination
              set $target_url $1://$2;
            }
            if ( $target_url ~ (.+?)%3A(.*) ){ # fix : between destination and port
              set $target_url $1:$2;
            }
            if ( $target_url ~ (.+?)%2F(.*) ){ # fix / after port, the rest will be decoded by proxy_pass
              set $target_url $1/$2;
            }
            resolver 8.8.8.8;
            proxy_pass_request_headers off;
            proxy_set_header Content-Type $http_content_type;
            proxy_set_header Content-Encoding $http_content_encoding;
            proxy_set_header Content-Length $http_content_length;
            proxy_read_timeout 120s;
            proxy_connect_timeout 5s;
            proxy_send_timeout 120s;
            proxy_ssl_server_name on;
            proxy_pass $target_url;
            proxy_intercept_errors on;
            error_page 301 302 307 = @handle_proxy_redirect;
        }
        location @handle_proxy_redirect {
            resolver 8.8.8.8;
            set $saved_redirect_location '$upstream_http_location';
            proxy_pass $saved_redirect_location;
        }

        # Proxy everything else to the app
        location / {
            proxy_pass http://umap_app;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Proxy buffering for large responses (e.g., map downloads)
            # Increase buffer size to avoid temporary file buffering warnings
            proxy_buffering on;
            proxy_buffer_size 16k;
            proxy_buffers 16 16k;
            proxy_busy_buffers_size 32k;
            
            # WebSocket support for realtime functionality
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            # Nur für HTML: kein Browser-Cache (Entry-Points/Assets bleiben unverändert)
            # Verwende map-Variablen statt if, da if in nginx problematisch ist
            add_header Cache-Control $html_cache_control always;
            add_header Expires $html_expires always;
            add_header Pragma $html_pragma always;

            # Timeouts
            proxy_connect_timeout 5s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
            
            # Access-Log deaktiviert - Host-Nginx loggt alles
            access_log off;
        }
    }
}
