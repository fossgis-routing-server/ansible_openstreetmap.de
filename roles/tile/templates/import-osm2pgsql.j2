#!/bin/bash
#
# -- Maintained with ansible. DO NOT EDIT! --
#
# Creates the render DB from the current planet.

set -e

{% if osrm__small %}
OSM_SOURCE=http://download.geofabrik.de/europe/liechtenstein-latest.osm.pbf
{% else %}
OSM_SOURCE=https://ftp5.gwdg.de/pub/misc/openstreetmap/planet.openstreetmap.org/pbf/planet-latest.osm.pbf
{% endif %}

sudo -u {{ tile__user }} wget $OSM_SOURCE -O {{ tile__basedir }}/planet.osm.pbf

{% if not osrm__small %}
sudo -u tile pyosmium-up-to-date <%= @planet %> -s 10000

{% endif %}

sudo -u www-data osm2pgsql -G -c -d {{ dbname }} --slim -C 100000 -O flex \
  --number-processes {{ ansible_facts['processor_cores'] }} -S {{ lua }} \
  --flat-nodes {{ tile__flatnode }} --middle-way-node-index-id-shift 5 \
  {{ tile__basedir }}/planet.osm.pbf

sudo -u www-data psql -d gis -f {{ style }}/indexes.sql

pyosmium-get-changes -O {{ tile__basedir }}/planet.osm.pbf -f {{ sequence }} --ignore-osmosis-headers
