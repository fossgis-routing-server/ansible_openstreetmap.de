- name: "Create user accounts"
  when: "item.hosts == 'all' or inventory_hostname in item.hosts"
  user:
    name: "{{ item.name }}"
    groups: sudo
    password: ""
    shell: "/bin/bash"
    update_password: on_create
  loop: "{{ users }}"

- name: "Remove users who do not have permissions to access this host"
  when: "item.hosts != 'all' and inventory_hostname not in item.hosts"
  user:
    name: "{{ item.name }}"
    state: absent
  loop: "{{ users }}"

- name: "Add SSH public key for user {{ item.name }}"
  when: "item.0.hosts == 'all' or inventory_hostname in item.0.hosts"
  authorized_key:
    user: "{{ item.0.name }}"
    key: "{{ item.1 }}"
  loop: "{{ users|subelements('ssh_public_keys') }}"

- name: Install sudo
  apt:
    name: sudo
